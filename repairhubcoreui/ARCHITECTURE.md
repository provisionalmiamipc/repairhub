# ğŸ—ï¸ Arquitectura del Sistema - AutenticaciÃ³n Dual JWT+PIN

## ğŸ“ Diagrama General del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          FRONTEND (Angular 20)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   LOGIN      â”‚         â”‚ LOGIN + PIN  â”‚        â”‚  DASHBOARD   â”‚         â”‚
â”‚  â”‚  COMPONENT   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  MODAL       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  (Protected) â”‚         â”‚
â”‚  â”‚              â”‚         â”‚  COMPONENT   â”‚        â”‚   by Guard   â”‚         â”‚
â”‚  â”‚              â”‚         â”‚              â”‚        â”‚              â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                          â–²                   â”‚
â”‚                                                          â”‚                   â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                    â”‚                                        â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                    â”‚                              â”‚                        â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”                    â”‚
â”‚              â”‚  INACTIVITYâ”‚         â”‚ LOCK ACCOUNT   â”‚                    â”‚
â”‚              â”‚   TIMER    â”‚         â”‚   (Header)     â”‚                    â”‚
â”‚              â”‚  (5 min)   â”‚         â”‚                â”‚                    â”‚
â”‚              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                    â”‚                          â”‚                           â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                               â”‚                                           â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                    â”‚ VERIFY PIN PAGE    â”‚                                â”‚
â”‚                    â”‚ (Reshow PIN Modal) â”‚                                â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                               â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚         AUTH SERVICE (Servicios Centrales)              â”‚             â”‚
â”‚  â”‚                                                          â”‚             â”‚
â”‚  â”‚  â”œâ”€ login()              â†’ POST /api/auth/login         â”‚             â”‚
â”‚  â”‚  â”œâ”€ verifyPin()          â†’ POST /api/auth/verify-pin    â”‚             â”‚
â”‚  â”‚  â”œâ”€ lockSession()        â†’ Auto (inactividad)           â”‚             â”‚
â”‚  â”‚  â”œâ”€ lockAccount()        â†’ Manual (header button)       â”‚             â”‚
â”‚  â”‚  â”œâ”€ unlockSession()      â†’ PIN verificaciÃ³n exitosa     â”‚             â”‚
â”‚  â”‚  â”œâ”€ isPinVerified()      â†’ Chequeo estado actual        â”‚             â”‚
â”‚  â”‚  â”œâ”€ setPinVerified()     â†’ Marcar verificado            â”‚             â”‚
â”‚  â”‚  â””â”€ isEmployeeLocked()   â†’ Chequeo si bloqueado        â”‚             â”‚
â”‚  â”‚                                                          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                             â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚    GUARDS & INTERCEPTORES                               â”‚             â”‚
â”‚  â”‚                                                          â”‚             â”‚
â”‚  â”‚  â”œâ”€ pinVerificationGuard                               â”‚             â”‚
â”‚  â”‚  â”‚   â””â”€ Protege rutas de empleados                    â”‚             â”‚
â”‚  â”‚  â”‚   â””â”€ Redirige a /verify-pin si:                    â”‚             â”‚
â”‚  â”‚  â”‚       â€¢ isEmployeeLocked() = true                 â”‚             â”‚
â”‚  â”‚  â”‚       â€¢ isPinVerified() = false                   â”‚             â”‚
â”‚  â”‚  â”‚                                                      â”‚             â”‚
â”‚  â”‚  â””â”€ mockApiInterceptor (DEV)                           â”‚             â”‚
â”‚  â”‚      â””â”€ Maneja POST /api/auth/verify-pin              â”‚             â”‚
â”‚  â”‚      â””â”€ Genera JWT fake para testing                  â”‚             â”‚
â”‚  â”‚                                                          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                             â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                       â”‚
                  â”‚  HTTP REQUESTS        â”‚
                  â”‚  (HttpClient)         â”‚
                  â”‚                       â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                           â”‚
        â–¼                                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BACKEND API     â”‚                    â”‚  LOCAL STORAGE   â”‚
â”‚  (NestJS)        â”‚                    â”‚  (Persistencia)  â”‚
â”‚                  â”‚                    â”‚                  â”‚
â”‚ POST /login      â”‚                    â”‚ - auth_token     â”‚
â”‚ POST /verify-pin â”‚                    â”‚ - user_type      â”‚
â”‚ POST /refresh    â”‚                    â”‚ - employee_data  â”‚
â”‚ POST /logout     â”‚                    â”‚ - pin_verified   â”‚
â”‚                  â”‚                    â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Flujo de AutenticaciÃ³n Detallado

### Secuencia 1: Login + PIN (Empleado)

```
Usuario                    Frontend                   Backend
  â”‚                          â”‚                           â”‚
  â”‚ 1. Ingresar credenciales â”‚                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                           â”‚
  â”‚                          â”‚ 2. POST /api/auth/login   â”‚
  â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                          â”‚                           â”‚ Validar creds
  â”‚                          â”‚                           â”‚ Generar JWT
  â”‚                          â”‚ 3. {token, employee}â—€â”€â”€â”€â”€â”€â”¤
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
  â”‚                          â”‚                           â”‚
  â”‚ 4. Detecta userType      â”‚                           â”‚
  â”‚    === 'employee'        â”‚                           â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
  â”‚                          â”‚                           â”‚
  â”‚ 5. Mostrar PIN Modal     â”‚                           â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
  â”‚                          â”‚                           â”‚
  â”‚ 6. Ingresar PIN          â”‚                           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                           â”‚
  â”‚                          â”‚ 7. POST /verify-pin       â”‚
  â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                          â”‚                           â”‚ Validar PIN
  â”‚                          â”‚                           â”‚ Generar JWT
  â”‚                          â”‚ 8. {verified, token}â—€â”€â”€â”€â”€â”€â”¤
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
  â”‚                          â”‚                           â”‚
  â”‚ 9. setPinVerified(true)  â”‚                           â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
  â”‚                          â”‚                           â”‚
  â”‚ 10. Navigate to          â”‚                           â”‚
  â”‚     /dashboard           â”‚                           â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
  â”‚                          â”‚                           â”‚
  â”‚ 11. Guard check:         â”‚                           â”‚
  â”‚     âœ“ isPinVerified      â”‚                           â”‚
  â”‚     âœ“ !isLocked         â”‚                           â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
  â”‚                          â”‚                           â”‚
  â”‚ 12. Dashboard loaded     â”‚                           â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
  â”‚                          â”‚                           â”‚
```

### Secuencia 2: Inactividad + PIN (Auto-lock)

```
Usuario (Inactivo)         Frontend                Backend
  â”‚                          â”‚                       â”‚
  â”‚ [5 min sin actividad]    â”‚                       â”‚
  â”‚ mouse/keyboard/scroll    â”‚                       â”‚
  â”‚                          â”‚                       â”‚
  â”‚                    Timer expira                  â”‚
  â”‚                          â”‚                       â”‚
  â”‚                   lockSession()                  â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
  â”‚                          â”‚                       â”‚
  â”‚              isLocked: true                      â”‚
  â”‚              pinVerified: false                  â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
  â”‚                          â”‚                       â”‚
  â”‚ [Intenta navegar]        â”‚                       â”‚
  â”‚                          â”‚                       â”‚
  â”‚              Guard check:                        â”‚
  â”‚              - isLocked? TRUE âœ—                  â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
  â”‚                          â”‚                       â”‚
  â”‚ Redirige a /verify-pin   â”‚                       â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
  â”‚                          â”‚                       â”‚
  â”‚ PIN Modal aparece        â”‚                       â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
  â”‚                          â”‚                       â”‚
  â”‚ Ingresar PIN             â”‚                       â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                       â”‚
  â”‚                          â”‚ POST /verify-pin      â”‚
  â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                          â”‚                       â”‚ Validar
  â”‚                          â”‚ {verified: true}â—€â”€â”€â”€â”€â”€â”¤
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
  â”‚                          â”‚                       â”‚
  â”‚  unlockSession()         â”‚                       â”‚
  â”‚  isLocked: false         â”‚                       â”‚
  â”‚  pinVerified: true       â”‚                       â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
  â”‚                          â”‚                       â”‚
  â”‚ Navigate /dashboard      â”‚                       â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
  â”‚                          â”‚                       â”‚
  â”‚ Guard check: PASS âœ“      â”‚                       â”‚
  â”‚                          â”‚                       â”‚
  â”‚ SesiÃ³n reactivada        â”‚                       â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
```

### Secuencia 3: Lock Manual

```
Usuario                    Frontend              Backend
  â”‚                          â”‚                     â”‚
  â”‚ Click "Lock Account"     â”‚                     â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚
  â”‚                          â”‚                     â”‚
  â”‚              onLockAccount()                   â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
  â”‚                          â”‚                     â”‚
  â”‚        lockAccount()      â”‚                     â”‚
  â”‚        isLocked: true     â”‚                     â”‚
  â”‚        pinVerified: false â”‚                     â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
  â”‚                          â”‚                     â”‚
  â”‚  Navigate /verify-pin    â”‚                     â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
  â”‚                          â”‚                     â”‚
  â”‚ PIN Modal visible        â”‚                     â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
  â”‚                          â”‚                     â”‚
  â”‚ Ingresar PIN             â”‚                     â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚
  â”‚                          â”‚ POST /verify-pin    â”‚
  â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                          â”‚                     â”‚
  â”‚                          â”‚ {verified: true}â—€â”€â”€â”€â”¤
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
  â”‚                          â”‚                     â”‚
  â”‚ unlockSession()          â”‚                     â”‚
  â”‚ isLocked: false          â”‚                     â”‚
  â”‚ pinVerified: true        â”‚                     â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
  â”‚                          â”‚                     â”‚
  â”‚ Navigate /dashboard      â”‚                     â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
  â”‚                          â”‚                     â”‚
  â”‚ SesiÃ³n activa nuevamente â”‚                     â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
```

## ğŸ› ï¸ Estructura de Archivos

```
src/app/
â”‚
â”œâ”€â”€ shared/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â”œâ”€â”€ login.component.ts          [Control flujo PIN]
â”‚   â”‚   â”‚   â””â”€â”€ login.component.html        [PIN Modal condicional]
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ pin-input-modal/
â”‚   â”‚   â”‚   â”œâ”€â”€ pin-input-modal.component.ts      [ValidaciÃ³n PIN]
â”‚   â”‚   â”‚   â”œâ”€â”€ pin-input-modal.component.html    [UI del modal]
â”‚   â”‚   â”‚   â”œâ”€â”€ pin-input-modal.component.scss    [Estilos]
â”‚   â”‚   â”‚   â””â”€â”€ pin-input-modal.component.spec.ts [Tests: 40+ casos]
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ verify-pin-page/
â”‚   â”‚       â””â”€â”€ verify-pin-page.component.ts  [PÃ¡gina de verificaciÃ³n]
â”‚   â”‚
â”‚   â”œâ”€â”€ guards/
â”‚   â”‚   â”œâ”€â”€ auth.guard.ts              [Token valido]
â”‚   â”‚   â”œâ”€â”€ pin.guard.ts               [Ruta /verify-pin]
â”‚   â”‚   â””â”€â”€ pin-verification.guard.ts  [Rutas protegidas]â—€â”€ NUEVO
â”‚   â”‚
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ auth.service.ts            [LÃ³gica centralizada]
â”‚   â”‚       â”œâ”€ login()
â”‚   â”‚       â”œâ”€ verifyPin()
â”‚   â”‚       â”œâ”€ lockSession()
â”‚   â”‚       â”œâ”€ lockAccount()           â—€â”€ NUEVO
â”‚   â”‚       â”œâ”€ unlockSession()
â”‚   â”‚       â”œâ”€ isPinVerified()         â—€â”€ NUEVO
â”‚   â”‚       â””â”€ setPinVerified()        â—€â”€ NUEVO
â”‚   â”‚
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ pin-verification.model.ts  [Interfaces]
â”‚   â”‚
â”‚   â””â”€â”€ interceptors/
â”‚       â””â”€â”€ mock-api.interceptor.ts    [/verify-pin mock]
â”‚
â”œâ”€â”€ layout/
â”‚   â””â”€â”€ default-layout/
â”‚       â””â”€â”€ default-header/
â”‚           â”œâ”€â”€ default-header.component.ts   [Lock Account handler]
â”‚           â””â”€â”€ default-header.component.html [Click binding]
â”‚
â””â”€â”€ app.routes.ts
    â”œâ”€ /login              [Sin guard]
    â”œâ”€ /verify-pin         [Sin guard, accesible]
    â””â”€ /dashboard          [+pinVerificationGuard]
```

## ğŸ”Œ Puntos de IntegraciÃ³n

### Con AuthService
```typescript
// Nuevo estado
authService.isPinVerified()       â†’ boolean
authService.pinVerified$          â†’ Observable<boolean>

// Nuevos mÃ©todos
authService.verifyPin(pin)        â†’ Observable<VerifyPinResponse>
authService.lockAccount()         â†’ void
authService.setPinVerified(bool)  â†’ void
authService.requiresPinVerification(type) â†’ boolean
```

### Con Guards
```typescript
// Guard existente
authGuard                          â†’ Chequea JWT vÃ¡lido

// Guard existente pero mejorado
pinGuard                           â†’ Ruta /verify-pin

// Guard nuevo
pinVerificationGuard              â†’ Chequea PIN verified para rutas
```

### Con Componentes
```typescript
// Login component ahora:
- Detecta employee post-login
- Muestra PIN modal
- Maneja verificaciÃ³n

// Header component ahora:
- BotÃ³n "Lock Account" funciona
- Llama authService.lockAccount()
- Navega a /verify-pin
```

## ğŸ“Š Estados de Empleado

```
Estado Inicial
â”œâ”€ isLocked: false
â”œâ”€ pinVerified: false
â”œâ”€ localStorage: vacio
â””â”€ Ruta: /login

                    â”‚
                    â–¼
            Login Exitoso
            â”œâ”€ Token guardado
            â”œâ”€ Employee data
            â””â”€ PIN modal mostrado
            
                    â”‚
                    â–¼
            PIN Correcto
            â”œâ”€ isLocked: false âœ“
            â”œâ”€ pinVerified: true âœ“
            â””â”€ localStorage: 'pin_verified'=true
            
                    â”‚
                    â–¼
            Activo en Dashboard
            â”œâ”€ Guard: PASS
            â”œâ”€ Timer: ejecutÃ¡ndose
            â””â”€ NavegaciÃ³n: libre
            
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚            â”‚
    5min inactivo  Click lock  Logout
        â”‚            â”‚            â”‚
        â–¼            â–¼            â–¼
    lockSession()  lockAccount()  cleanup
    â””â”€ isLocked: true
    â””â”€ pinVerified: false
    â””â”€ Redirige: /verify-pin
    â””â”€ Modal: visible
    
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                PIN Verificado
                â”œâ”€ unlockSession()
                â”œâ”€ pinVerified: true âœ“
                â””â”€ Navigate: /dashboard
```

## ğŸ¯ Flujo de DecisiÃ³n de Guard

```
Usuario intenta acceder /dashboard
         â”‚
         â–¼
Â¿EstÃ¡ logueado?
(authGuard)
         â”‚
      NOâ”‚  SÃ
        â”‚   â”‚
   /login   â”‚
         â”‚  â–¼
         â”‚ Â¿userType === 'employee'?
         â”‚  â”‚
         â”‚NOâ”‚ SÃ
         â”‚   â”‚
         â”‚  /  Â¿isEmployeeLocked()?
         â”‚ â”‚   â”‚
         â”‚ â”‚YESâ”‚ NO
         â”‚ â”‚ â”‚  â”‚
         â”‚ â”‚ â”‚  â–¼
         â”‚ â”‚ â”‚ Â¿isPinVerified()?
         â”‚ â”‚ â”‚  â”‚
         â”‚ â”‚ â”‚NOâ”‚ YES
         â”‚ â”‚ â”‚  â”‚  â”‚
    dashboard   â”‚  â”‚
    (acceso)   â”‚  â–¼
         â”‚ â”‚ â”‚ /verify-pin
         â”‚ â”‚ â”‚ (PIN modal)
         â”‚ â”‚ â”‚  â”‚
         â”‚ â”‚ â”‚  â–¼
         â”‚ â”‚ â”‚ [Ingresar PIN]
         â”‚ â”‚ â”‚  â”‚
         â”‚ â”‚ â”‚  â–¼
         â”‚ â”‚ â”‚ Â¿PIN vÃ¡lido?
         â”‚ â”‚ â”‚  â”‚
         â”‚ â”‚ â”‚NOâ”‚ SÃ
         â”‚ â”‚ â”‚  â”‚ â”‚
         â”‚ â”‚ â”‚  â”‚ â–¼
         â”‚ â”‚ â”‚  â”‚ setPinVerified(true)
         â”‚ â”‚ â”‚  â”‚ unlockSession()
         â”‚ â”‚ â”‚  â”‚ Navigate: /dashboard
         â”‚ â”‚ â”‚  â”‚  â”‚
         â”‚ â”‚ â”‚  â”‚  â–¼
         â”‚ â”‚ â”‚  â”‚ âœ… ACCESO CONCEDIDO
         â”‚ â”‚ â”‚  â”‚
         â”‚ â”‚ â”‚  â–¼ reintentar o logout
         â”‚ â”‚ â”‚
         â–¼ â–¼ â–¼
    [FIN DEL FLUJO]
```

---

**Ãšltima ActualizaciÃ³n:** 28 de enero de 2026  
**Status:** âœ… Completo y Funcional
