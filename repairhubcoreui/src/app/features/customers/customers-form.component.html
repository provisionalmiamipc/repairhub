<!-- components/customer-form/customer-form.component.html -->
<div class="container-fluid" style="margin-bottom: 60px">
  <div class="border rounded-4 shadow-sm p-4 p-lg-5 mx-auto" >
    
    <form [formGroup]="customerForm" (ngSubmit)="onSubmit()" autocomplete="off">
      @if (backendError) {
        <div class="alert alert-danger mt-2">{{ backendError }}</div>
      }
        
        <!-- Center & Store Selection (condicional por rol) -->
        @if (role === 'USER') {
          <div class="mb-4 p-3 p-lg-4 border rounded-3 bg-body">
            <div class="mb-3">
              <strong>Location Information</strong>
            </div>
            <div>
              <div class="row g-3">
                <!-- Center -->
                <div class="col-md-6">
                  <label class="form-label" for="centerId">Center *</label>
                  <select
                    class="form-select"
                    id="centerId"
                    formControlName="centerId"
                    [class.is-valid]="centerId?.valid && centerId?.touched"
                    [class.is-invalid]="centerId?.invalid && centerId?.touched">
                    <option value="" disabled selected>Select a center</option>
                    @for (center of centers; track center.id) {
                      <option [value]="center.id">{{ center.centerName }}</option>
                    }
                  </select>
                  @if (centerId?.invalid && centerId?.touched) {
                    <div class="invalid-feedback d-block">
                      @if (centerId?.errors?.['required']) {
                        <span>Center is required</span>
                      }
                    </div>
                  }
                </div>
                <!-- Store -->
                <div class="col-md-6">
                  <label class="form-label" for="storeId">Store *</label>
                  <select
                    class="form-select"
                    id="storeId"
                    formControlName="storeId"
                    [class.is-valid]="storeId?.valid && storeId?.touched"
                    [class.is-invalid]="storeId?.invalid && storeId?.touched">
                    <option value="null" disabled selected>Select a store</option>
                    @for (store of filterStores; track store.id) {
                      <option [value]="store.id">{{ store.storeName }}</option>
                    }
                  </select>
                  @if (storeId?.invalid && storeId?.touched) {
                    <div class="invalid-feedback d-block">
                      @if (storeId?.errors?.['required']) {
                        <span>Store is required</span>
                      }
                    </div>
                  }
                  <div class="form-text" [class.text-warning]="!hasStores && centerId?.value">
                    {{ storeHelpText }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        } @else if (role === 'EMPLOYEE' && isAdminCenter) {
          <div class="mb-4 p-3 p-lg-4 border rounded-3 bg-body">
            <div class="mb-3">
              <strong>Location Information</strong>
            </div>
            <div>
              <div class="row g-3">
                <!-- Store (solo storeId, centerId oculto y fijo) -->
                <div class="col-md-6">
                  <label class="form-label" for="storeId">Store *</label>
                  <select
                    class="form-select"
                    id="storeId"
                    formControlName="storeId"
                    [class.is-valid]="storeId?.valid && storeId?.touched"
                    [class.is-invalid]="storeId?.invalid && storeId?.touched">
                    <option value="null" disabled selected>Select a store</option>
                    @for (store of filterStores; track store.id) {
                      <option [value]="store.id">{{ store.storeName }}</option>
                    }
                  </select>
                  @if (storeId?.invalid && storeId?.touched) {
                    <div class="invalid-feedback d-block">
                      @if (storeId?.errors?.['required']) {
                        <span>Store is required</span>
                      }
                    </div>
                  }
                  <div class="form-text" [class.text-warning]="!hasStores && centerIdDefault">
                    {{ storeHelpText }}
                  </div>
                </div>
                <!-- Campo oculto para centerId (valor fijo) -->
                <input type="hidden" formControlName="centerId" [value]="centerIdDefault" autocomplete="off">
              </div>
            </div>
          </div>
        } @else if (role === 'EMPLOYEE' && !isAdminCenter) {
          <!-- Para EMPLOYEE sin isAdminCenter: ambos campos ocultos, valores por defecto -->
          <input type="hidden" formControlName="centerId" [value]="centerIdDefault" autocomplete="off">
          <input type="hidden" formControlName="storeId" [value]="storeIdDefault" autocomplete="off">
        }

        <!-- Personal Information -->
        <div class="mb-4 p-3 p-lg-4 border rounded-3 bg-body">
          <div class="mb-3">
            <strong>Personal Information</strong>
          </div>
          <div>
            <div class="row g-3">
              
              <!-- First Name -->
              <div class="col-md-6">
                
                  <label class="form-label" for="firstName">First Name *</label>
                  <input
                    class="form-control"
                    type="text"
                    id="firstName"
                    formControlName="firstName"
                    [class.is-valid]="firstName?.valid && firstName?.touched"
                    [class.is-invalid]="firstName?.invalid && firstName?.touched"
                    placeholder="Enter first name"
                    autocomplete="off">
                  @if (firstName?.invalid && firstName?.touched) {
                    <div class="invalid-feedback d-block">
                      @if (firstName?.errors?.['required']) {
                        <span>First name is required</span>
                      }
                      @if (firstName?.errors?.['minlength']) {
                        <span>First name must be at least 2 characters</span>
                      }
                      @if (firstName?.errors?.['maxlength']) {
                        <span>First name cannot exceed 50 characters</span>
                      }
                    </div>
                  }
                
              </div>

              <!-- Last Name -->
              <div class="col-md-6">
                
                  <label class="form-label" for="lastName">Last Name *</label>
                  <input
                    class="form-control"
                    type="text"
                    id="lastName"
                    formControlName="lastName"
                    [class.is-valid]="lastName?.valid && lastName?.touched"
                    [class.is-invalid]="lastName?.invalid && lastName?.touched"
                    placeholder="Enter last name"
                    autocomplete="off">
                  @if (lastName?.invalid && lastName?.touched) {
                    <div class="invalid-feedback d-block">
                      @if (lastName?.errors?.['required']) {
                        <span>Last name is required</span>
                      }
                      @if (lastName?.errors?.['minlength']) {
                        <span>Last name must be at least 2 characters</span>
                      }
                    </div>
                  }
                
              </div>

              <!-- Phone -->
              <div class="col-md-6">
                
                  <label class="form-label" for="phone">Phone *</label>
                  <input
                    class="form-control"
                    type="tel"
                    id="phone"
                    formControlName="phone"
                    [class.is-valid]="phone?.valid && phone?.touched"
                    [class.is-invalid]="phone?.invalid && phone?.touched"
                    placeholder="Enter phone number"
                    autocomplete="off">
                  @if (phone?.invalid && phone?.touched) {
                    <div class="invalid-feedback d-block">
                      @if (phone?.errors?.['required']) {
                        <span>Phone number is required</span>
                      }
                      @if (phone?.errors?.['pattern']) {
                        <span>Please enter a valid phone number</span>
                      }
                    </div>
                  }
                
              </div>

              <!-- Email -->
              <div class="col-md-6">
                
                  <label class="form-label" for="email">Email *</label>
                  <input
                    class="form-control"
                    type="email"
                    id="email"
                    formControlName="email"
                    [class.is-valid]="email?.valid && email?.touched"
                    [class.is-invalid]="email?.invalid && email?.touched"
                    placeholder="Enter email address"
                    autocomplete="off">
                  @if (email?.invalid && email?.touched) {
                    <div class="invalid-feedback d-block">
                      @if (email?.errors?.['required']) {
                        <span>Email is required</span>
                      }
                      @if (email?.errors?.['email']) {
                        <span>Please enter a valid email address</span>
                      }
                    </div>
                  }
                
              </div>

              <!-- City -->
              <div class="col-md-6">
                
                  <label class="form-label" for="city">Address</label>
                  <input
                    class="form-control"
                    type="text"
                    id="city"
                    formControlName="city"
                    [class.is-valid]="city?.valid && city?.touched"
                    [class.is-invalid]="city?.invalid && city?.touched"
                    placeholder="Enter city"
                    autocomplete="off">
                  @if (city?.invalid && city?.touched) {
                    <div class="invalid-feedback d-block">
                      @if (city?.errors?.['required']) {
                        <span>Address is required</span>
                      }
                      @if (city?.errors?.['minlength']) {
                        <span>Address must be at least 2 characters</span>
                      }
                    </div>
                  }
                
              </div>

              <!-- Gender -->
              <div class="col-md-6">
                
                  <label class="form-label" for="gender">Gender *</label>
                  <select
                    class="form-select"
                    id="gender"
                    formControlName="gender"
                    [class.is-valid]="gender?.valid && gender?.touched"
                    [class.is-invalid]="gender?.invalid && gender?.touched">
                    <option value="" disabled selected>Select gender</option>
                    @for (g of genders; track g) {
                      <option [value]="g">{{ g }}</option>
                    }
                  </select>
                  @if (gender?.invalid && gender?.touched) {
                    <div class="invalid-feedback d-block">
                      @if (gender?.errors?.['required']) {
                        <span>Gender is required</span>
                      }
                    </div>
                  }
                
              </div>

            </div>
          </div>
        </div>

        <!-- Additional Information -->
        <div class="mb-4 p-3 p-lg-4 border rounded-3 bg-body">
          <div class="mb-3">
            <strong>Additional Information</strong>
          </div>
          <div>
            <div class="row g-3">
              
              <!-- Extra Info -->
              <div class="col-12">
                
                  <label class="form-label" for="extraInfo">Additional Information</label>
                  <textarea
                    class="form-control"
                    id="extraInfo"
                    formControlName="extraInfo"
                    [class.is-valid]="extraInfo?.valid && extraInfo?.touched"
                    [class.is-invalid]="extraInfo?.invalid && extraInfo?.touched"
                    placeholder="Enter any additional information"
                    rows="4"></textarea>
                  @if (extraInfo?.invalid && extraInfo?.touched) {
                    <div class="invalid-feedback d-block">
                      @if (extraInfo?.errors?.['maxlength']) {
                        <span>Additional information cannot exceed 500 characters</span>
                      }
                    </div>
                  }
                  <div class="form-text">
                    {{ extraInfo?.value?.length || 0 }}/500 characters
                  </div>
                
              </div>

              <!-- B2B & Discount -->
              <div class="col-md-6">
                
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="b2b"
                      formControlName="b2b"
                      autocomplete="off">
                    <label class="form-check-label" for="b2b">
                      Business Customer (B2B)
                    </label>
                  </div>
                
              </div>

              <div class="col-md-3">
                <div class="input-group">
                  <span class="input-group-text">Discount (%)</span>
                  <input
                    class="form-control"
                    type="number"
                    id="discount"
                    formControlName="discount"
                    [class.is-valid]="discount?.valid && discount?.touched"
                    [class.is-invalid]="discount?.invalid && discount?.touched"
                    placeholder="0"
                    min="0"
                    max="100"
                    step="0.1"
                    autocomplete="off">
                </div>
                @if (discount?.invalid && discount?.touched) {
                  <div class="invalid-feedback d-block">
                    @if (discount?.errors?.['min']) {
                      <span>Discount cannot be negative</span>
                    }
                    @if (discount?.errors?.['max']) {
                      <span>Discount cannot exceed 100%</span>
                    }
                  </div>
                }
              </div>

            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-2 justify-content-end">
          <button
            class="btn btn-outline-secondary"
            type="button"
            (click)="onCancel()"
            [disabled]="isSubmitting">
            Cancel
          </button>
          
          <button
            class="btn btn-primary"
            type="submit"
            [disabled]="isSubmitting || customerForm.invalid">
            @if (isSubmitting) {
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              Saving...
            } @else {
              {{ customer ? 'Update' : 'Create' }} Customer
            }
          </button>
        </div>

      </form>
  </div>
</div>