<div class="items-container">
  <!-- Header -->
  <div class="header-section">
    <div class="header-content">
      <div>
        <h1><i class="bi bi-box-seam me-2" aria-hidden="true"></i>Item Management</h1>
        <p class="subtitle">{{ filteredItems().length }} items found</p>
      </div>
      <div class="header-actions d-flex align-items-center">
        <div class="btn-group me-2" role="group" aria-label="View toggle">
          <button
            class="btn btn-outline-secondary btn-sm"
            (click)="setView('professional')"
            [class.active]="viewMode() === 'professional'"
            [attr.aria-pressed]="viewMode() === 'professional'"
            title="Professional list"
            aria-label="Professional list"
          >
            <i class="bi bi-list-ul"></i>
          </button>
          <button
            class="btn btn-outline-secondary btn-sm"
            (click)="setView('cards')"
            [class.active]="viewMode() === 'cards'"
            [attr.aria-pressed]="viewMode() === 'cards'"
            title="Card view"
            aria-label="Card view"
          >
            <i class="bi bi-grid-3x3-gap"></i>
          </button>
        </div>

        <button class="btn btn-primary btn-sm" (click)="createNew()">
          <span class="me-1">+</span> New Item
        </button>
      </div>
    </div>
  </div>

  <!-- Search & Filters -->
  <div class="filters-section">
    <div class="search-box">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
        <path d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" fill="currentColor"/>
      </svg>
      <input
        type="text"
        placeholder="Search by name, SKU or barcode..."
        (input)="onSearchChange($event.target.value)"
      />
    </div>

    <div class="filter-group">
      <select (change)="onFilterChange('status', $any($event).target.value)">
        <option value="all">All statuses</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>

      <select (change)="onFilterChange('center', $any($event).target.value)">
        <option value="0">All centers</option>
        <option *ngFor="let center of centers()" [value]="center.id">
          {{ center.centerName }}
        </option>
      </select>

      <select (change)="onFilterChange('store', $any($event).target.value)">
        <option value="0">All stores</option>
        <option *ngFor="let store of stores()" [value]="store.id">
          {{ store.storeName }}
        </option>
      </select>

      <select (change)="onFilterChange('type', $any($event).target.value)">
        <option value="0">All types</option>
        <option *ngFor="let type of itemTypes()" [value]="type.id">
          {{ type.name }}
        </option>
      </select>

      <select (change)="onSortChange($any($event).target.value)">
        <option value="date">Most recent</option>
        <option value="product">Name (A-Z)</option>
        <option value="sku">SKU (A-Z)</option>
        <option value="price">Price (Highest)</option>
        <option value="stock">Stock (Highest)</option>
      </select>
    </div>
  </div>

  <!-- Loading State -->
  @if (listState().isLoading) {
    <div class="loading-state">
      <div class="loader"></div>
      <p>Loading items...</p>
    </div>
  }

  <!-- Error State -->
  @if (listState().error) {
    <div class="error-state">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <h3>Error loading</h3>
      <p>{{ listState().error }}</p>
      <button class="btn btn-secondary" (click)="retryLoad()">Retry</button>
    </div>
  }

  <!-- Empty State -->
  @if (isEmptyState()) {
    <div class="empty-state">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M9 2h6m-3 16v3m-8-8h16m-16 0a2 2 0 012-2h12a2 2 0 012 2v6H3v-6z"></path>
      </svg>
      <h3>No items</h3>
      <p>There are no items matching the selected filters</p>
      <button class="btn btn-primary" (click)="createNew()">Create first item</button>
    </div>
  }

  <!-- Items Grid / Table -->
  <ng-container *ngIf="!listState().isLoading && !listState().error && !isEmptyState()">
    <ng-container *ngIf="viewMode() === 'professional'; else cardsView">
      <div class="items-table table-responsive" @fadeInUp>
        <table class="table table-striped table-hover align-middle">
          <thead>
            <tr>
              <th>Product</th>
              <th>SKU</th>
              <th>Barcode</th>              
              <th>State</th>
              <th>Type</th>
              <th>Stock</th>
              <th></th>
              <th>Price</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="isEmptyState()">
              <td colspan="9" class="text-center">No items found. <button class="btn btn-sm btn-link" (click)="createNew()">Create one</button></td>
            </tr>
            <tr *ngFor="let item of filteredItems()">
              <td>{{ item.product }}</td>
              <td>{{ item.sku }}</td>
              <td>{{ item.barcode || '-' }}</td>              
              <td>{{ item.isActive ? 'Active' : 'Inactive' }}</td>
              <td>{{ getTypeName(item.itemTypeId) }}</td>
              <td>{{ item.stock }} </td>
              <th>
                <div *ngIf="getStockStatus(item) === 'critical'" class="stock-badge critical">ðŸ”´ Out of stock</div>
                <div *ngIf="getStockStatus(item) === 'low'" class="stock-badge low">ðŸŸ¡ Low stock</div>
              </th>
              <td>{{ formatCurrency(item.price) }}</td>
              <td>
                <button class="btn btn-sm btn-outline-secondary me-1" (click)="viewItem(item)" title="View"><i class="bi bi-eye"></i></button>
                <button class="btn btn-sm btn-outline-secondary" (click)="editItem(item)" title="Edit"><i class="bi bi-pencil"></i></button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </ng-container>
    <ng-template #cardsView>
      <div class="items-grid">
        <div class="item-card" *ngFor="let item of filteredItems()" [@fadeInUp]>
          <div class="card-header">
            <div class="status-badge" [class]="item.isActive ? 'active' : 'inactive'">
              {{ item.isActive ? 'âœ“ Active' : 'âœ— Inactive' }}
            </div>
            <div *ngIf="getStockStatus(item) === 'critical'" class="stock-badge critical">ðŸ”´ Out of stock</div>
            <div *ngIf="getStockStatus(item) === 'low'" class="stock-badge low">ðŸŸ¡ Low stock</div>
          </div>

          <div class="card-content">
            <h3 class="product-name">{{ item.product }}</h3>
            
            <div class="info-grid">
              <div class="info-item">
                <span class="label">SKU</span>
                <span class="value">{{ item.sku }}</span>
              </div>
              <div class="info-item">
                <span class="label">Barcode</span>
                <span class="value">{{ item.barcode || '-' }}</span>
              </div>
              <div class="info-item">
                <span class="label">Center</span>
                <span class="value">{{ getCenterName(getItemCenterId(item)) }}</span>
              </div>
              <div class="info-item">
                <span class="label">Store</span>
                <span class="value">{{ getStoreName(getItemStoreId(item)) }}</span>
              </div>
              <div class="info-item">
                <span class="label">Type</span>
                <span class="value">{{ getTypeName(item.itemTypeId) }}</span>
              </div>
              <div class="info-item">
                <span class="label">Description</span>
                <span class="value">{{ item.shortTitleDesc || '-' }}</span>
              </div>
            </div>

            <!-- Price & Margin -->
            <div *ngIf="!(authService.isExpert() && !authService.getCurrentEmployee()?.isCenterAdmin)" class="price-section">
              <div class="price-row">
                <span class="label">Cost</span>
                <span class="value">{{ formatCurrency(item.cost) }}</span>
              </div>
              <div class="price-row">
                <span class="label">Price</span>
                <span class="value amount">{{ formatCurrency(item.price) }}</span>
              </div>
              <div class="price-row">
                <span class="label">Margin</span>
                <span class="value" [class]="getPriceMargin(item) > 0 ? 'positive' : 'negative'">
                  {{ getPriceMargin(item).toFixed(1) }}%
                </span>
              </div>
            </div>

            <!-- Stock Info -->
            <div class="stock-section">
              <div class="stock-item">
                <span class="label">Current Stock</span>
                <span class="value" [class]="getStockStatus(item)">{{ item.stock }}</span>
              </div>
              <div class="stock-item">
                <span class="label">Minimum Stock</span>
                <span class="value">{{ item.minimunStock }}</span>
              </div>
              <div class="stock-item">
                <span class="label">Discount</span>
                <span class="value">{{ item.discount }}%</span>
              </div>
              <div class="stock-item">
                <span class="label">Warranty</span>
                <span class="value">{{ item.warranty }} months</span>
              </div>
            </div>

            <!-- Taxable & Warranty -->
            <div class="features-section">
              <span *ngIf="item.taxable" class="feature-badge taxable">Taxable</span>
              <span *ngIf="item.warranty > 0" class="feature-badge warranty">Warranty</span>
            </div>

            <!-- Dates -->
            <div class="dates-info">
              <small>Created: {{ item.createdAt | date: 'short' }}</small>
              <small>Updated: {{ item.updatedAt | date: 'short' }}</small>
            </div>
          </div>

          <!-- Actions -->
          <div class="card-actions">
            <button class="action-btn view" (click)="viewItem(item)" title="View details">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </button>
            <button class="action-btn edit" (click)="editItem(item)" title="Edit">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 3a2.828 2.828 0 114 4L7.5 20.5 2 22l1.5-5.5L21 7z"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </ng-template>
  </ng-container>
</div>
