<div class="form-container container-xxl py-4" @fadeInUp>
  <!-- Header Section -->
  <div class="form-header text-center mb-4">
    <div class="header-content">
      <h1 class="form-title display-6 fw-bold mb-1">
        {{ isEditMode() ? 'Edit Service Order' : 'New Service Order' }}
      </h1>
      <p class="form-subtitle text-muted">
        {{ isEditMode() ? 'Update the required fields' : 'Complete the steps to create a service order' }}
      </p>
    </div>
  </div>

  <!-- Progress Bar (only in create mode) -->
  @if (showSteps()) {
  <div class="progress-section mb-4">
    <div class="progress" style="height: 8px;">
      <div class="progress-bar bg-primary" role="progressbar" [style.width.%]="getStepProgress()"
        [attr.aria-valuenow]="getStepProgress()" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <p class="text-center text-muted mt-2 mb-0 small">Step {{ currentStep() + 1 }} of {{ steps.length }}</p>
  </div>
  }

  <!-- Error Message -->
  @if (error()) {
  <div class="alert alert-error alert-danger d-flex align-items-center gap-2" role="alert" @slideInFrom>
    <span class="alert-icon"><i class="bi bi-exclamation-triangle"></i></span>
    <span class="alert-message">{{ error() }}</span>
    <button class="btn-close ms-auto" type="button" aria-label="Close" (click)="clearError()"></button>
  </div>
  }

  <!-- Success Message -->
  @if (success()) {
  <div class="alert alert-success d-flex align-items-center gap-2" role="alert" @slideInFrom>
    <span class="alert-icon"><i class="bi bi-check-circle"></i></span>
    <span class="alert-message">Order saved successfully</span>
  </div>
  }

  <!-- Loading State -->
  @if (isLoading()) {
  <div class="d-flex flex-column align-items-center justify-content-center py-5 gap-3">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted mb-0">Loading information...</p>
  </div>
  } @else {
  <form class="needs-validation" [formGroup]="serviceOrderForm" (ngSubmit)="onSubmit()">
    <!-- EDIT MODE: Show all fields at once -->
    @if (isEditMode()) {
    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
          <div class="card-body p-4">
            <!-- Step 0: Center & Store -->
            <div class="section-group mb-4">
              <h2 class="step-title h3 fw-bold text-primary border-bottom border-2 border-primary pb-2 mb-3">{{
                steps[0].title }}</h2>
              <div class="row g-3">
                <!-- Center & Store fields visibility by user type -->
                @if (showCenterAndStoreFields()) {
                <!-- USER: Mostrar ambos campos -->
                <div class="col-md-6 col-xl-6">
                  <label for="centerId" class="form-label">Center *</label>
                  <select id="centerId" class="form-select form-select-lg mb-3"
                    [class.is-invalid]="isFieldInvalid('centerId')" formControlName="centerId">
                    <option value="" selected>Select center</option>
                    @for (center of centers(); track center.id) {
                    <option [value]="center.id">{{ center.centerName }}</option>
                    }
                  </select>
                  @if (isFieldInvalid('centerId')) {
                  <div class="invalid-feedback d-block">{{ getFieldError('centerId') }}</div>
                  }
                </div>
                <div class="col-md-6 col-xl-6">
                  <label for="storeId" class="form-label">Store *</label>
                  <select id="storeId" class="form-select form-select-lg mb-3"
                    [class.is-invalid]="isFieldInvalid('storeId')" formControlName="storeId">
                    <option value="" selected>Select store...</option>
                    @for (store of filteredStores(); track store.id) {
                    <option [value]="store.id">{{ store.storeName }}</option>
                    }
                  </select>
                  @if (isFieldInvalid('storeId')) {
                  <span class="error-message">{{ getFieldError('storeId') }}</span>
                  }
                </div>
                } @else if (showOnlyStoreField()) {
                <!-- EMPLOYEE isCenterAdmin: Solo mostrar storeId -->
                <div class="col-md-6 col-xl-6">
                  <label for="storeId" class="form-label">Store *</label>
                  <select id="storeId" class="form-select form-select-lg mb-3"
                    [class.is-invalid]="isFieldInvalid('storeId')" formControlName="storeId">
                    <option value="" selected>Select store...</option>
                    @for (store of filteredStores(); track store.id) {
                    <option [value]="store.id">{{ store.storeName }}</option>
                    }
                  </select>
                  @if (isFieldInvalid('storeId')) {
                  <span class="error-message">{{ getFieldError('storeId') }}</span>
                  }
                </div>
                } @else if (hideLocationFields()) {
                <!-- EMPLOYEE normal: ocultar ambos campos, usar valores por defecto -->
                <input type="hidden" formControlName="centerId" />
                <input type="hidden" formControlName="storeId" />
                }
              </div>
            </div>

            <!-- Step 1: Customer & Device -->
            <div class="section-group mb-4">
              <h2 class="step-title h3 fw-bold text-primary border-bottom border-2 border-primary pb-2 mb-3">{{
                steps[1].title }}</h2>
              <div class="row g-3">
                <!-- Customer -->
                <div class="col-md-6 col-xl-4">
                  <label for="customerId" class="form-label">Customer *</label>
                  <div class="input-group">
                    <select id="customerId" class="form-select" [class.is-invalid]="isFieldInvalid('customerId')"
                      formControlName="customerId">
                      <option [ngValue]="null" disabled>Select customer</option>
                      @for (customer of customers(); track customer.id) {
                      <option [value]="customer.id">{{ customer.firstName }} {{ customer.lastName }}</option>
                      }
                    </select>
                    <button class="btn btn-outline-secondary" type="button" (click)="openCustomerSearch()">
                      <i class="bi bi-search"></i>
                    </button>
                    <button class="btn btn-outline-primary" type="button" (click)="openCustomerForm()"
                      [disabled]="isOrderFinalized()">
                      <i class="bi bi-person-plus"></i>
                    </button>
                  </div>
                  @if (isFieldInvalid('customerId')) {
                  <span class="error-message">{{ getFieldError('customerId') }}</span>
                  }
                </div>

                <!-- Device -->
                <div class="col-md-6 col-xl-4">
                  <label for="deviceId" class="form-label">Device *</label>
                  <div class="input-group">
                    <select id="deviceId" class="form-select" [class.is-invalid]="isFieldInvalid('deviceId')"
                      formControlName="deviceId">
                      <option [ngValue]="null" disabled>Select device</option>
                      @for (device of devices(); track device.id) {
                      <option [value]="device.id">{{ device.name }}</option>
                      }
                    </select>
                    <button class="btn btn-outline-secondary" type="button" (click)="openAddDevice()">+</button>
                  </div>
                  @if (isFieldInvalid('deviceId')) {
                  <span class="error-message">{{ getFieldError('deviceId') }}</span>
                  }
                </div>

                <!-- Device Brand -->
                <div class="col-md-6 col-xl-4">
                  <label for="deviceBrandId" class="form-label">Brand *</label>
                  <div class="input-group">
                    <select id="deviceBrandId" class="form-select" [class.is-invalid]="isFieldInvalid('deviceBrandId')"
                      formControlName="deviceBrandId">
                      <option [ngValue]="null" disabled>Select brand</option>
                      @for (brand of deviceBrands(); track brand.id) {
                      <option [value]="brand.id">{{ brand.name }}</option>
                      }
                    </select>
                    <button class="btn btn-outline-secondary" type="button" (click)="openAddDeviceBrand()">+</button>
                  </div>
                  @if (isFieldInvalid('deviceBrandId')) {
                  <span class="error-message">{{ getFieldError('deviceBrandId') }}</span>
                  }
                </div>
              </div>
            </div>

            <!-- Assignment -->
            <div class="section-group mb-4">
              <h2 class="step-title h3 fw-bold text-primary border-bottom border-2 border-primary pb-2 mb-3">Assignment
              </h2>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="assignedTechId" class="form-label">Assigned Technician *</label>
                  <select id="assignedTechId" class="form-select" [class.is-invalid]="isFieldInvalid('assignedTechId')"
                    formControlName="assignedTechId">
                    <option [ngValue]="null" disabled>Select technician</option>
                    @for (employee of employees(); track employee.id) {
                    <option [value]="employee.id">{{ employee.firstName }} {{ employee.lastName }}</option>
                    }
                  </select>
                  @if (isFieldInvalid('assignedTechId')) {
                  <span class="error-message">{{ getFieldError('assignedTechId') }}</span>
                  }
                </div>

                @if (showCenterAndStoreFields()) {
                <div class="col-md-6">
                  <label for="createdById" class="form-label">Created By *</label>
                  <select id="createdById" class="form-select" [class.is-invalid]="isFieldInvalid('createdById')"
                    formControlName="createdById">
                    <option value="" disabled>Select user</option>
                    @for (employee of employees(); track employee.id) {
                    <option [value]="employee.id">{{ employee.firstName }} {{ employee.lastName }}</option>
                    }
                  </select>
                  @if (isFieldInvalid('createdById')) {
                  <span class="error-message">{{ getFieldError('createdById') }}</span>
                  }
                </div>
                }
              </div>
            </div>

            <!-- Step 2: Technical Details -->
            <div class="section-group mb-4">
              <h2 class="step-title h3 fw-bold text-primary border-bottom border-2 border-primary pb-2 mb-3">{{
                steps[2].title }}</h2>
              <div class="row g-3">
                <!-- Model -->
                <div class="col-md-6 col-xl-4">
                  <label for="model" class="form-label">Model *</label>
                  <input type="text" id="model" class="form-control" [class.is-invalid]="isFieldInvalid('model')"
                    formControlName="model" placeholder="Device model" />
                  @if (isFieldInvalid('model')) {
                  <span class="error-message">{{ getFieldError('model') }}</span>
                  }
                </div>

                <!-- Serial -->
                <div class="col-md-6 col-xl-4">
                  <label for="serial" class="form-label">Serial</label>
                  <input type="text" id="serial" class="form-control" formControlName="serial"
                    placeholder="Serial number" />
                </div>

                <!-- Defective Part -->
                <div class="col-12">
                  <label for="defectivePart" class="form-label">Defective Part</label>
                  <input type="text" id="defectivePart" class="form-control" formControlName="defectivePart"
                    placeholder="Describe the defective part" />
                </div>

                <!-- Reception Note -->
                <div class="col-12">
                  <label for="noteReception" class="form-label">Reception Notes</label>
                  <textarea id="noteReception" class="form-control" formControlName="noteReception"
                    placeholder="Additional notes..." rows="3"></textarea>
                </div>

                <!-- Status (edit only) -->
                <div class="col-12">
                  <div class="form-check">
                    <input id="lock" type="checkbox" formControlName="lock" class="form-check-input" />
                    <label class="form-check-label" for="lock">Lock order</label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Step 3: Costs -->
            <div class="section-group mb-4">
              <h2 class="step-title h3 fw-bold text-primary border-bottom border-2 border-primary pb-2 mb-3">{{
                steps[3].title }}</h2>
              <div class="row g-3">
                <!-- Price -->
                <div class="col-md-6 col-xl-4">
                  <label for="price" class="form-label">Price *</label>
                  <input type="number" id="price" class="form-control" [class.is-invalid]="isFieldInvalid('price')"
                    formControlName="price" min="0" step="0" />
                  @if (isFieldInvalid('price')) {
                  <span class="error-message">{{ getFieldError('price') }}</span>
                  }
                </div>

                <!-- Repair Cost -->
                <div class="col-md-6 col-xl-4">
                  <label for="repairCost" class="form-label">Repair Cost *</label>
                  <input type="number" id="repairCost" class="form-control"
                    [class.is-invalid]="isFieldInvalid('repairCost')" formControlName="repairCost" min="0" step="0" />
                  @if (isFieldInvalid('repairCost')) {
                  <span class="error-message">{{ getFieldError('repairCost') }}</span>
                  }
                </div>

                <!-- Discount -->
                <div class="col-md-6 col-xl-4">
                  <label for="costdiscount" class="form-label">Discount</label>
                  <input type="number" id="costdiscount" class="form-control" formControlName="costdiscount" min="0"
                    step="0" />
                </div>

                <!-- Advance Payment -->
                <div class="col-md-6 col-xl-4">
                  <label for="advancePayment" class="form-label">Advance Payment</label>
                  <input type="number" id="advancePayment" class="form-control" formControlName="advancePayment" min="0"
                    step="0" />
                </div>

                <!-- Payment Type -->
                <div class="col-md-6 col-xl-4">
                  <label for="paymentTypeId" class="form-label">Payment Type</label>
                  <div class="input-group">
                    <select id="paymentTypeId" class="form-select" formControlName="paymentTypeId">
                      <option [ngValue]="null">Select payment type</option>
                      @for (paymentType of paymentTypes(); track paymentType.id) {
                      <option [value]="paymentType.id">{{ paymentType.type }}</option>
                      }
                    </select>
                    <button class="btn btn-outline-secondary" type="button" (click)="openAddPaymentType()">+</button>
                  </div>
                </div>

                <!-- Tax -->
                <div class="col-md-6 col-xl-4">
                  <label for="tax" class="form-label">Tax</label>
                  <input type="number" id="tax" class="form-control" formControlName="tax" min="0" step="0" />
                </div>

                <!-- Total Cost (read-only) -->
                <div class="col-md-6 col-xl-">
                  <label for="totalCost" class="form-label">Total Cost</label>
                  <input type="number" id="totalCost" class="form-control" formControlName="totalCost" readonly />
                  <small class="text-muted">Calculated automatically</small>
                </div>
                <div class="col-md-2 col-xl-2"></div>
                <div class="col-md-6 col-xl-4">
                  @if (isEditMode()) {
                  <div class="mt-2">
                    <div class="d-flex justify-content-between">
                      <div class="text-muted">Suggested Min Price</div>
                      <div class="fw-bold">{{ formatCurrency(getSuggestedPrice()) }}</div>
                    </div>
                    <div class="d-flex justify-content-between">
                      <div class="text-muted">TAX:</div>
                      <div class="fw-bold">{{ formatCurrency(getTaxAmount()) }}</div>
                    </div>
                    <div class="d-flex justify-content-between border-top pt-2 mt-2">
                      <div class="text-muted">Total</div>
                      <div class="fw-bold">{{ formatCurrency(getSuggestedTotal()) }}</div>
                    </div>
                  </div>
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
          <div class="card-body p-4">
            <h2 class="step-title mb-3">Related</h2>

            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Notes</span>
                <button *ngIf="!isOrderFinalized()" class="btn btn-sm btn-outline-primary" type="button"
                  (click)="openAddNote()">+</button>
              </div>
              <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                  @for (n of soNotes; track n.id) {
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div>{{ n.note }}</div>
                    <div class="btn-group btn-group-sm">
                      <button *ngIf="!isOrderFinalized()" class="btn btn-link" type="button"
                        (click)="openEditNote(n)">Edit</button>
                      <button class="btn btn-link text-danger" type="button" (click)="deleteNote(n.id)">Delete</button>
                    </div>
                  </li>
                  }
                  @if (!soNotes.length) {
                  <li class="list-group-item text-muted">No notes</li>
                  }
                </ul>
              </div>
            </div>

            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Diagnostics</span>
                <button *ngIf="!isOrderFinalized()" class="btn btn-sm btn-outline-primary" type="button"
                  (click)="openAddDiagnostic()">+</button>
              </div>
              <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                  @for (d of soDiagnostics; track d.id) {
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div>{{ d.diagnostic }}</div>
                    <div class="btn-group btn-group-sm">
                      <button *ngIf="!isOrderFinalized()" class="btn btn-link" type="button"
                        (click)="openEditDiagnostic(d)">Edit</button>
                      <button class="btn btn-link text-danger" type="button"
                        (click)="deleteDiagnostic(d.id)">Delete</button>
                    </div>
                  </li>
                  }
                  @if (!soDiagnostics.length) {
                  <li class="list-group-item text-muted">No diagnostics</li>
                  }
                </ul>
              </div>
            </div>

            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Statuses</span>
                <button *ngIf="!isOrderFinalized()" class="btn btn-sm btn-outline-primary" type="button"
                  (click)="openAddStatus()">+</button>
              </div>
              <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                  @for (s of repairStatuses; track s.id) {
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div>{{ s.status }}</div>
                    <div class="btn-group btn-group-sm">
                      <button *ngIf="!isOrderFinalized()" class="btn btn-link" type="button"
                        (click)="openEditStatus(s)">Edit</button>
                      <button class="btn btn-link text-danger" type="button"
                        (click)="deleteStatus(s.id)">Delete</button>
                    </div>
                  </li>
                  }
                  @if (!repairStatuses.length) {
                  <li class="list-group-item text-muted">No statuses</li>
                  }
                </ul>
              </div>
            </div>

            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Items</span>
                <button *ngIf="!isOrderFinalized()" class="btn btn-sm btn-outline-primary" type="button"
                  (click)="openAddItem()">+</button>
              </div>
              <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                  @for (i of soItems; track i.id) {
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div>
                      <div class="fw-bold">{{ i.item?.product || i.note || 'Item' }}</div>
                      <small class="text-muted">Qty: {{ i.quantity }} â€” Price: {{ i.price }}</small>
                    </div>
                    <div class="btn-group btn-group-sm">
                      <button *ngIf="!isOrderFinalized()" class="btn btn-link" type="button"
                        (click)="openEditItem(i)">Edit</button>
                      <button class="btn btn-link text-danger" type="button" (click)="deleteItem(i.id)">Delete</button>
                    </div>
                  </li>
                  }
                  @if (!soItems.length) {
                  <li class="list-group-item text-muted">No items</li>
                  }
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    } @else {
    <!-- CREATE MODE: Show stepped form -->
    <div class="card border-0 shadow-sm">
      <div class="card-body p-4">
        <!-- Step 0: Center & Store -->
        @if (currentStep() === 0) {
        <div class="form-step" @slideInFrom>
          <h2 class="step-title h4 fw-bold text-primary mb-2">{{ steps[0].title }}</h2>
          <p class="step-description text-muted mb-4">{{ steps[0].description }}</p>

          <div class="row g-3">
            @if (showCenterAndStoreFields()) {
            <!-- USER: Mostrar ambos campos -->
            <div class="col-md-6">
              <label for="centerId" class="form-label">Center *</label>
              <select id="centerId" class="form-select form-select-lg mb-3"
                [class.is-invalid]="isFieldInvalid('centerId')" formControlName="centerId">
                <option value="" selected>Select...</option>
                @for (center of centers(); track center.id) {
                <option [value]="center.id">{{ center.centerName }}</option>
                }
              </select>
              @if (isFieldInvalid('centerId')) {
              <span class="error-message">{{ getFieldError('centerId') }}</span>
              }
            </div>
            <div class="col-md-6">
              <label for="storeId" class="form-label">Store *</label>
              <select id="storeId" class="form-select form-select-lg mb-3"
                [class.is-invalid]="isFieldInvalid('storeId')" formControlName="storeId">
                <option value="" selected>Select store...</option>
                @for (store of filteredStores(); track store.id) {
                <option [value]="store.id">{{ store.storeName }}</option>
                }
              </select>
              @if (isFieldInvalid('storeId')) {
              <span class="error-message">{{ getFieldError('storeId') }}</span>
              }
            </div>
            } @else if (showOnlyStoreField()) {
            <!-- EMPLOYEE isCenterAdmin: Solo mostrar storeId -->
            <div class="col-md-6">
              <label for="storeId" class="form-label">Store *</label>
              <select id="storeId" class="form-select form-select-lg mb-3"
                [class.is-invalid]="isFieldInvalid('storeId')" formControlName="storeId">
                <option value="" selected>Select store...</option>
                @for (store of filteredStores(); track store.id) {
                <option [value]="store.id">{{ store.storeName }}</option>
                }
              </select>
              @if (isFieldInvalid('storeId')) {
              <span class="error-message">{{ getFieldError('storeId') }}</span>
              }
            </div>
            } @else if (hideLocationFields()) {
            <!-- EMPLOYEE normal: ocultar ambos campos, usar valores por defecto -->
            <input type="hidden" formControlName="centerId" />
            <input type="hidden" formControlName="storeId" />
            }
          </div>
        </div>
        }

        <!-- Step 1: Customer & Device -->
        @if (currentStep() === 1) {
        <div class="form-step" @slideInFrom>
          <h2 class="step-title">{{ steps[1].title }}</h2>
          <p class="step-description">{{ steps[1].description }}</p>

          <div class="row g-3">
            <!-- Customer -->
            <div class="col-md-6 col-xl-4">
              <label for="customerId" class="form-label">Customer *</label>
              <div class="input-group">
                <select id="customerId" class="form-select" [class.is-invalid]="isFieldInvalid('customerId')"
                  formControlName="customerId">
                  <option [ngValue]="null" disabled>Select customer</option>
                  @for (customer of customers(); track customer.id) {
                  <option [value]="customer.id">{{ customer.firstName }} {{ customer.lastName }}</option>
                  }
                </select>
                <button class="btn btn-outline-secondary" type="button" (click)="openCustomerSearch()">
                  <i class="bi bi-search"></i>
                </button>
              </div>
              @if (isFieldInvalid('customerId')) {
              <span class="error-message">{{ getFieldError('customerId') }}</span>
              }
            </div>

            <!-- Device -->
            <div class="col-md-6 col-xl-4">
              <label for="deviceId" class="form-label">Device *</label>
              <div class="input-group">
                <select id="deviceId" class="form-select" [class.is-invalid]="isFieldInvalid('deviceId')"
                  formControlName="deviceId">
                  <option [ngValue]="null" disabled>Select device</option>
                  @for (device of devices(); track device.id) {
                  <option [value]="device.id">{{ device.name }}</option>
                  }
                </select>
                <button class="btn btn-outline-secondary" type="button" (click)="openAddDevice()">+</button>
              </div>
              @if (isFieldInvalid('deviceId')) {
              <span class="error-message">{{ getFieldError('deviceId') }}</span>
              }
            </div>

            <!-- Device Brand -->
            <div class="col-md-6 col-xl-4">
              <label for="deviceBrandId" class="form-label">Brand *</label>
              <div class="input-group">
                <select id="deviceBrandId" class="form-select" [class.is-invalid]="isFieldInvalid('deviceBrandId')"
                  formControlName="deviceBrandId">
                  <option [ngValue]="null" disabled>Select brand</option>
                  @for (brand of deviceBrands(); track brand.id) {
                  <option [value]="brand.id">{{ brand.name }}</option>
                  }
                </select>
                <button class="btn btn-outline-secondary" type="button" (click)="openAddDeviceBrand()">+</button>
              </div>
              @if (isFieldInvalid('deviceBrandId')) {
              <span class="error-message">{{ getFieldError('deviceBrandId') }}</span>
              }
            </div>
          </div>
        </div>
        }

        <!-- Step 2: Technical Details -->
        @if (currentStep() === 2) {
        <div class="form-step" @slideInFrom>
          <h2 class="step-title">{{ steps[2].title }}</h2>
          <p class="step-description">{{ steps[2].description }}</p>

          <div class="row g-3">
            <!-- Model -->
            <div class="col-md-6 col-xl-4">
              <label for="model" class="form-label">Model *</label>
              <input type="text" id="model" class="form-control" [class.is-invalid]="isFieldInvalid('model')"
                formControlName="model" placeholder="Device model" />
              @if (isFieldInvalid('model')) {
              <span class="error-message">{{ getFieldError('model') }}</span>
              }
            </div>

            <!-- Serial -->
            <div class="col-md-6 col-xl-4">
              <label for="serial" class="form-label">Serial</label>
              <input type="text" id="serial" class="form-control" formControlName="serial"
                placeholder="Serial number" />
            </div>

            <!-- Defective Part -->
            <div class="col-12">
              <label for="defectivePart" class="form-label">Defective Part</label>
              <input type="text" id="defectivePart" class="form-control" formControlName="defectivePart"
                placeholder="Describe the defective part" />
            </div>

            <!-- Reception Note -->
            <div class="col-12">
              <label for="noteReception" class="form-label">Reception Notes</label>
              <textarea id="noteReception" class="form-control" formControlName="noteReception"
                placeholder="Additional notes..." rows="3"></textarea>
            </div>

          </div>
        </div>
        }

        <!-- Step 3: Costs -->
        @if (currentStep() === 3) {
        <div class="form-step" @slideInFrom>
          <h2 class="step-title">{{ steps[3].title }}</h2>
          <p class="step-description">{{ steps[3].description }}</p>

          <div class="row g-3">
            <!-- Price -->
            <div class="col-md-6 col-xl-4">
              <label for="price" class="form-label">Price *</label>
              <input type="number" id="price" class="form-control" [class.is-invalid]="isFieldInvalid('price')"
                formControlName="price" min="0" step="0" />
              @if (isFieldInvalid('price')) {
              <span class="error-message">{{ getFieldError('price') }}</span>
              }
            </div>

            <!-- Repair Cost -->
            <div class="col-md-6 col-xl-4">
              <label for="repairCost" class="form-label">Repair Cost *</label>
              <input type="number" id="repairCost" class="form-control"
                [class.is-invalid]="isFieldInvalid('repairCost')" formControlName="repairCost" min="0" step="0" />
              @if (isFieldInvalid('repairCost')) {
              <span class="error-message">{{ getFieldError('repairCost') }}</span>
              }
            </div>

            <!-- Discount -->
            <div class="col-md-6 col-xl-4">
              <label for="costdiscount" class="form-label">Discount</label>
              <input type="number" id="costdiscount" class="form-control" formControlName="costdiscount" min="0"
                step="0" />
            </div>

            <!-- Tax -->
            <div class="col-md-6 col-xl-4">
              <label for="tax" class="form-label">Tax</label>
              <input type="number" id="tax" class="form-control" formControlName="tax" min="0" step="0" />
            </div>

            <!-- Advance Payment -->
            <div class="col-md-6 col-xl-4">
              <label for="advancePayment" class="form-label">Advance Payment</label>
              <input type="number" id="advancePayment" class="form-control" formControlName="advancePayment" min="0"
                step="0" />
            </div>

            <!-- Payment Type -->
            <div class="col-md-6 col-xl-4">
              <label for="paymentTypeId" class="form-label">Payment Type *</label>
              <div class="input-group">
                <select id="paymentTypeId" class="form-select" [class.is-invalid]="isFieldInvalid('paymentTypeId')"
                  formControlName="paymentTypeId">
                  <option [ngValue]="null" disabled>Select payment type</option>
                  @for (type of paymentTypes(); track type.id) {
                  <option [value]="type.id">{{ type.type }}</option>
                  }
                </select>
                <button class="btn btn-outline-secondary" type="button" (click)="openAddPaymentType()">+</button>
              </div>
              @if (isFieldInvalid('paymentTypeId')) {
              <span class="error-message">{{ getFieldError('paymentTypeId') }}</span>
              }
            </div>

            <!-- Assigned Tech -->
            <div class="col-md-6 col-xl-4">
              <label for="assignedTechId" class="form-label">Assigned Technician *</label>
              <select id="assignedTechId" class="form-select" [class.is-invalid]="isFieldInvalid('assignedTechId')"
                formControlName="assignedTechId">
                <option [ngValue]="null" disabled>Select technician</option>
                @for (employee of employees(); track employee.id) {
                <option [value]="employee.id">{{ employee.firstName }} {{ employee.lastName }}</option>
                }
              </select>
              @if (isFieldInvalid('assignedTechId')) {
              <span class="error-message">{{ getFieldError('assignedTechId') }}</span>
              }
            </div>

            <!-- Created By -->
            @if (showCenterAndStoreFields()) {
            <div class="col-md-6 col-xl-4">
              <label for="createdById" class="form-label">Created By *</label>
              <select id="createdById" class="form-select" [class.is-invalid]="isFieldInvalid('createdById')"
                formControlName="createdById">
                <option value="" disabled>Select user</option>
                @for (employee of employees(); track employee.id) {
                <option [value]="employee.id">{{ employee.firstName }} {{ employee.lastName }}</option>
                }
              </select>
              @if (isFieldInvalid('createdById')) {
              <span class="error-message">{{ getFieldError('createdById') }}</span>
              }
            </div>
            }

            <!-- Total Cost (Calculated) -->
            <div class="col-12">
              <div class="alert alert-info mb-0">
                <label for="totalCost" class="form-label">Total Cost (Calculated)</label>
                <input type="number" id="totalCost" class="form-control" formControlName="totalCost" readonly />
                <small class="help-text d-block mt-1">Automatically calculated: Price + Repair - Discount + Tax</small>
              </div>
            </div>
          </div>
        </div>
        }

        <!-- Step Indicators (only in create mode) -->
        @if (showSteps()) {
        <div class="steps-indicator d-flex flex-wrap gap-2 justify-content-center mt-3 mb-4">
          @for (step of steps; track step.id) {
          <button type="button" class="btn btn-sm rounded-circle fw-semibold" [ngClass]="{
              'btn-primary text-white': currentStep() === step.id,
              'btn-success text-white': currentStep() > step.id,
              'btn-outline-secondary': currentStep() < step.id
            }" style="width: 36px; height: 36px;" (click)="currentStep.set(step.id)"
            [disabled]="currentStep() < step.id">
            {{ step.id + 1 }}
          </button>
          }
        </div>
        }
      </div>
    </div>
    }

    <div class="d-flex flex-wrap gap-2 justify-content-end mt-4 pt-3 border-top">
      @if (isEditMode() && !isOrderFinalized()) {
      <button type="button" class="btn btn-outline-success" (click)="completeOrder()" [disabled]="isSaving()">
        <i class="bi bi-check-circle me-1"></i> Complete
      </button>
      <button type="button" class="btn btn-outline-danger" (click)="cancelOrder()" [disabled]="isSaving()">
        <i class="bi bi-x-circle me-1"></i> Cancel Order
      </button>
      }
      <button type="button" class="btn btn-outline-secondary" (click)="onCancel()" [disabled]="isSaving()">
        <i class="bi bi-x-circle me-1"></i> Close
      </button>

      <!-- Navigation buttons (only in create mode) -->
      @if (showSteps()) {
      @if (currentStep() > 0) {
      <button type="button" class="btn btn-outline-secondary" (click)="prevStep()" [disabled]="isSaving()">
        <i class="bi bi-arrow-left me-1"></i> Previous
      </button>
      }

      @if (currentStep() < steps.length - 1) { <button type="button" class="btn btn-primary" (click)="nextStep()"
        [disabled]="!canProceedToNextStep() || isSaving()">
        Next <i class="bi bi-arrow-right ms-1"></i>
        </button>
        }
        }

        <!-- Submit button -->
        @if (!showSteps() || currentStep() === steps.length - 1) {
        <button type="submit" class="btn btn-success"
          [disabled]="!serviceOrderForm.valid || isSaving() || isOrderFinalized()">
          @if (isSaving()) {
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Saving...
          } @else {
          <i class="bi bi-check-circle me-1"></i> {{ isEditMode() ? 'Update' : 'Create' }} Order
          }
        </button>
        }
    </div>
  </form>
  }

  @if (showDeviceModal) {
  <app-devices-form [device]="editingDevice" [isModal]="true" (save)="onDeviceSaved($event)"
    (cancel)="closeDeviceModal()"></app-devices-form>
  }

  @if (showDeviceBrandModal) {
  <app-device-brands-form [deviceBrand]="editingDeviceBrand" [isModal]="true" (save)="onDeviceBrandSaved($event)"
    (cancel)="closeDeviceBrandModal()"></app-device-brands-form>
  }

  @if (showPaymentTypeModal) {
  <app-payment-types-form [paymentType]="editingPaymentType" [isModal]="true" (save)="onPaymentTypeSaved($event)"
    (cancel)="closePaymentTypeModal()"></app-payment-types-form>
  }

  @if (showCustomerSearch) {
  <app-customer-search [isModal]="true" (select)="onCustomerSelected($event)"
    (cancel)="closeCustomerSearch()"></app-customer-search>
  }

  @if (showCustomerModal) {
  <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content border-0 shadow">
        <div class="modal-header">
          <h5 class="modal-title">New Customer</h5>
          <button type="button" class="btn-close" aria-label="Close" (click)="closeCustomerForm()"></button>
        </div>
        <div class="modal-body">
          <app-customers-form [customer]="editingCustomer" [centers]="centers()" [stores]="stores()"
            [role]="userType() === 'employee' ? 'EMPLOYEE' : 'USER'" [isAdminCenter]="isCenterAdmin()"
            [employeeCenterId]="authService.getCurrentEmployee()?.centerId ?? null"
            [employeeStoreId]="authService.getCurrentEmployee()?.storeId ?? null" (save)="onCustomerSaved($event)"
            (cancel)="closeCustomerForm()">
          </app-customers-form>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show"></div>
  }

  @if (showNoteModal) {
  <app-so-notes-form [soNotes]="editingNote" [serviceOrderId]="serviceOrder()?.id" [centerId]="serviceOrder()?.centerId"
    [storeId]="serviceOrder()?.storeId"
    [createdById]="serviceOrder()?.createdById ?? serviceOrderForm.get('createdById')?.value" [isModal]="true"
    (save)="onNoteSaved($event)" (cancel)="closeNoteModal()"></app-so-notes-form>
  }

  @if (showDiagnosticModal) {
  <app-so-diagnostic-form [soDiagnostic]="editingDiagnostic" [serviceOrderId]="serviceOrder()?.id"
    [centerId]="serviceOrder()?.centerId ?? serviceOrderForm.get('centerId')?.value"
    [storeId]="serviceOrder()?.storeId ?? serviceOrderForm.get('storeId')?.value"
    [createdById]="serviceOrder()?.createdById ?? serviceOrderForm.get('createdById')?.value" [isModal]="true"
    (save)="onDiagnosticSaved($event)" (cancel)="closeDiagnosticModal()"></app-so-diagnostic-form>
  }

  @if (showItemModal) {
  <app-so-items-form [soItem]="editingItem" [serviceOrderId]="serviceOrder()?.id"
    [centerId]="serviceOrder()?.centerId ?? serviceOrderForm.get('centerId')?.value"
    [storeId]="serviceOrder()?.storeId ?? serviceOrderForm.get('storeId')?.value"
    [createdById]="serviceOrder()?.createdById ?? serviceOrderForm.get('createdById')?.value" [isModal]="true"
    (save)="onItemSaved($event)" (cancel)="closeItemModal()"></app-so-items-form>
  }

  @if (showStatusModal) {
  <app-repair-status-form [repairStatus]="editingStatus" [serviceOrderIdInput]="serviceOrder()?.id"
    [centerIdInput]="serviceOrder()?.centerId ?? serviceOrderForm.get('centerId')?.value"
    [storeIdInput]="serviceOrder()?.storeId ?? serviceOrderForm.get('storeId')?.value"
    [createdByIdInput]="serviceOrder()?.createdById ?? serviceOrderForm.get('createdById')?.value" [isModal]="true"
    (save)="onStatusSaved($event)" (cancel)="closeStatusModal()"></app-repair-status-form>
  }
</div>